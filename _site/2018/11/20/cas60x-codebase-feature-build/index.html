<!DOCTYPE html>
<html>
<head>
    
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MZG9L7');</script>
    
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Apereo CAS 6.0.x - Building CAS Feature Modules &#8211; Apereo Community Blog</title>
    <link rel="dns-prefetch" href="//maxcdn.bootstrapcdn.com">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="An overview of how various CAS features modules today can be changed and tested from the perspective of a CAS contributor working on the codebase itself to handle a feature request, bug fix, etc.">
    <meta name="robots" content="all">
    <meta name="author" content="Apereo Project Participants">
    
    <meta name="keywords" content="">
    <link rel="canonical" href="https://apereo.github.io/2018/11/20/cas60x-codebase-feature-build/">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for Apereo Community Blog" href="/feed.xml" />

    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css"
          integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd"
          crossorigin="anonymous">

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/tether/1.3.7/js/tether.min.js"></script>
    
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/js/bootstrap.min.js"
            integrity="sha384-vZ2WRJMwsjRMW/8U7i6PWi6AlO1L79snBrmgiDpgIWJ82z8eA5lenwvxbMV1PAh7"
            crossorigin="anonymous"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/pixyll.css?202303081604" type="text/css">

    <!-- Fonts -->
    
    <link href='//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Lato:900,300&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    
    
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet">
    

    <!-- MathJax -->
    
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js??config=TeX-AMS-MML_HTMLorMML">
    </script>
    

    <!-- Verifications -->
    
    

    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Apereo CAS 6.0.x - Building CAS Feature Modules">
    <meta property="og:description" content="This is a blog managed and edited by the Apereo project participants. It is typically used to post project updates, announce news, etc.">
    <meta property="og:url" content="https://apereo.github.io/2018/11/20/cas60x-codebase-feature-build/">
    <meta property="og:site_name" content="Apereo Community Blog">
    
    <meta property="og:image" content="https://apereo.github.io/images/me.jpeg">
    

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    
        <meta name="twitter:site" content="@Apereo" />
        <meta name="twitter:creator" content="@Apereo" />
    
    <meta name="twitter:title" content="Apereo CAS 6.0.x - Building CAS Feature Modules" />
    <meta name="twitter:description" content="An overview of how various CAS features modules today can be changed and tested from the perspective of a CAS contributor working on the codebase itself to handle a feature request, bug fix, etc." />
    <meta name="twitter:url" content="https://apereo.github.io/2018/11/20/cas60x-codebase-feature-build/" />
    
    <meta name="twitter:image" content="https://apereo.github.io/images/me.jpeg" />
    

    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">

    
    <script type="text/javascript">
       (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
       ga('create', 'UA-83384532-1', 'auto');
       ga('send', 'pageview');
    </script>
    

    
    
</head>

<body class="site animated fade-in-down">
  

  <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MZG9L7"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-MZG9L7');</script>
  
  
	

  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="https://apereo.github.io" class="site-title">Apereo Community Blog</a>
      <nav class="site-nav">
        



    
    
    
    
        <a href="/about/">About</a>
    

    

    
    
    
    
        <a href="/contact/">Say Hello</a>
    

    

    
    
    
    
        <a href="/tags/">All Posts</a>
    

    

    
    
    
    
        <a href="/search/">Search</a>
    

    


      </nav>
      <div class="clearfix"></div>
      
        <div class="social-icons">
  <div class="social-icons-right">
    
      <a class="fa fa-github" href="https://github.com/apereo"></a>
    
    
    
    
    <a class="fa fa-rss" href="/feed.xml"></a>
    
      <a class="fa fa-twitter" href="https://twitter.com/Apereo"></a>
    
    
    
    
    
      <a class="fa fa-envelope" href="mailto:info@apereo.org"></a>
    
    
    
    
    
    
  </div>
  <div class="right">
    
    
    
  </div>
</div>
<div class="clearfix"></div>

      
    </div>
  </div>
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<div class="post-header mb2">
  <h1>Apereo CAS 6.0.x - Building CAS Feature Modules</h1>
  <span class="post-meta">Tuesday, Nov 20, 2018</span><br>
  
  <span class="post-meta small">
  
    13 minute read
  
  </span>
</div>

<article class="post-content">
  <div class="alert alert-success">
<strong>Collaborate</strong><br />This blog is managed and hosted on GitHub. If you wish to update the contents of this post or if you have found an inaccuracy and wish to make corrections, we recommend that you please submit a pull request to <a href="https://github.com/apereo/apereo.github.io">this repository</a>.
</div>

<h1 id="overview">Overview</h1>

<p>This quick walkthrough effectively aims for the following objectives:</p>

<ul>
  <li>A quick development environment setup using IntelliJ IDEA.</li>
  <li>Building and running the CAS web application using Gradle.</li>
  <li>Changing feature modules and testing out behavior.</li>
  <li>Testing changes and writing unit tests.</li>
  <li>Stepping into the code using a debugger.</li>
</ul>

<h1 id="development-environment">Development Environment</h1>

<p>Follow the <a href="https://apereo.github.io/cas/developer/Build-Process-6X.html">instructions posted here</a> to obtain the CAS source code. Remember to indicate the relevant <code class="highlighter-rouge">branch</code> in the commands indicated to obtain the right source code for the CAS version at hand. In this tutorial and just like before, the branch to use would be <code class="highlighter-rouge">6.0.x</code> (at the time of writing this post, the appropriate branch is <code class="highlighter-rouge">master</code>).</p>

<p>To understand what branches are available, <a href="https://github.com/apereo/cas/branches">see this link</a>. Your CAS version is closely tied to the branches listed in the codebase. For example, if you are deploying CAS <code class="highlighter-rouge">5.1.8</code>, then the relevant branch to check out would be <code class="highlighter-rouge">5.1.x</code>. Remember that branches always contain the most recent changeset and version of the release line. You might be deploying <code class="highlighter-rouge">5.1.8</code> while the <code class="highlighter-rouge">5.1.x</code> might be marching towards <code class="highlighter-rouge">5.1.10</code>. This requires that you first upgrade to the latest available patch release for the CAS version at hand and if the problem or use case continues to manifest, you can then check out the appropriate source branch and get fancy <sub>[1]</sub>.</p>

<div class="alert alert-info">
<strong>Keep Up</strong><br />It is <b>STRONGLY</b> recommended that you keep up with the patch releases as they come out. Test early and have the environment on hand for when the time comes to dabble into the source. Postponing patch upgrades in the interest of time will eventually depreciate your lifespan.</div>

<p>It is important that to let IntelliJ IDEA open and refresh the Gradle project (using the <em>Refresh</em> button on the Gradle window’s toolbar) once you do the initial import. Running <code class="highlighter-rouge">./gradlew idea</code> <strong>MAY</strong> work but it may also completely mess up the project structure especially if the plugin is not quite compatible with your IDE version. Note that similar tasks are available for eclipse.</p>

<p>For best results, try with IntelliJ IDEA <code class="highlighter-rouge">2018.3</code> (Ultimate Edition). Given the size of the CAS projects and the number of sub-modules, you need to make sure you have enough memory available for IDEA and that your custom JVM settings are correctly set per <a href="https://apereo.github.io/cas/developer/Build-Process-6X.html">the instructions here</a> for IntelliJ IDEA.</p>

<h1 id="system-requirements">System Requirements</h1>

<p>It’s best to get familiar with <a href="https://apereo.github.io/cas/6.0.x/planning/Installation-Requirements.html">CAS system requirements</a>. Most importantly, this means that your system must be prepped with JDK <code class="highlighter-rouge">11</code>. Just about any JDK variant from any JDK vendor would do the job.</p>

<div class="alert alert-danger">
  <strong>Important changes in Oracle JDK 11 License</strong><br />With JDK 11 Oracle has updated the license terms on which Oracle JDK is offered. The new Oracle Technology Network License Agreement for Oracle Java SE is substantially different from the licenses under which previous versions of the JDK were offered. <b>Please review</b> the new terms carefully before downloading and using this product. Oracle also offers this software under the GPL License on jdk.java.net/11.</div>

<p>For basic development and prototyping, try with:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>java <span class="nt">-version</span>

java version <span class="s2">"11"</span> 2018-09-25
Java<span class="o">(</span>TM<span class="o">)</span> SE Runtime Environment 18.9 <span class="o">(</span>build 11+28<span class="o">)</span>
Java HotSpot<span class="o">(</span>TM<span class="o">)</span> 64-Bit Server VM 18.9 <span class="o">(</span>build 11+28, mixed mode<span class="o">)</span>
</code></pre></div></div>

<h1 id="running-cas">Running CAS</h1>

<p>The CAS web application itself can be started from the command-prompt using an embedded Apache Tomcat container. In fact, this process is no different from deploying CAS using the same embedded Apache Tomcat container which means you will need to follow the <a href="https://apereo.github.io/cas/developer/Build-Process-6X.html">instructions posted here</a> in the way that certificates and other configurations are needed in <code class="highlighter-rouge">/etc/cas/config</code>, etc to ensure CAS can function as you need it. All feature modules and behavior that would be stuffed into the web application artifact continue to read settings from the same location, as they would be when activated from an overlay. The process is exactly the same.</p>

<p>I use the following alias in my bash profile to spin up CAS using an embedded Apache Tomcat container. You might want to do the same thing:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">alias </span><span class="nv">bc</span><span class="o">=</span><span class="s1">'clear; cd ~/Workspace/cas/webapp/cas-server-webapp-tomcat; \
    ../../gradlew build bootRun --configure-on-demand --build-cache --parallel \
    -x test -x javadoc -x check -DenableRemoteDebugging=true --stacktrace \
    -DskipNestedConfigMetadataGen=true -DskipGradleLint=true -DskipSass=true \
    -DskipNodeModulesCleanUp=true -DskipNpmCache=true -DskipNpmLint=true'</span>
</code></pre></div></div>

<p>Then, I simply execute the following in the terminal:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> bc
</code></pre></div></div>

<p>Since you’re running <code class="highlighter-rouge">bootRun</code> under the <code class="highlighter-rouge">cas-server-webapp-tomcat</code> module, the servlet container used will be based on Apache Tomcat. You can navigate to a different module that bases itself on top of a different servlet container such as Jetty.</p>

<div class="alert alert-info">
<strong>On Windows</strong><br />You can apply the same strategy on Windows by creating a <code>bc.bat</code> file and making sure it's available on the <code>PATH</code>. The syntax of course needs to be adjusted to account for file paths and commands.</div>

<p>To understand the meaning and function behind various command-line arguments, please see <a href="https://apereo.github.io/cas/developer/Build-Process-6X.html">instructions posted here</a>. You may optionally decide to tweak each setting if you are interested in a particular build variant, such as generating javadocs, running tests, etc. One particular flag of interest is the addition of <code class="highlighter-rouge">enableRemoteDebugging</code>, which allows you, later on, to connect a remote debugger to CAS on a specific port (i.e. <code class="highlighter-rouge">5000</code>) and step into the code. More on that later.</p>

<h1 id="testing-modules">Testing Modules</h1>

<p>Per <a href="https://apereo.github.io/cas/developer/Build-Process-6X.html">instructions posted here</a>, the inclusion of a particular build module in the Gradle build script of the CAS web application should allow the build process to automatically allow the module to be packaged and become available to the runtime. You may include the module reference in the <a href="https://github.com/apereo/cas/blob/6.0.x/gradle/webapp.gradle"><code class="highlighter-rouge">webapp.gradle</code></a> file, which is the common parent to build descriptors that do stuff with CAS web applications. Making changes in this file will ensure that it will be included <em>by default</em> in the generic CAS web application, regardless of how it is configured to run using a servlet container, which means you need to be extra careful about the sort of changes you make here and what is kept and what is checked in for follow-up pull requests and reviews.</p>

<p>So for reference and our task at hand, the file would look like the following:</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dependencies</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="n">implementation</span> <span class="nf">project</span><span class="o">(</span><span class="s2">":support:cas-server-support-some-module"</span><span class="o">)</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Note the reference locates the module using its full path. The next time you run <code class="highlighter-rouge">bc</code>, the final CAS web application will have enabled <code class="highlighter-rouge">some-module</code> functionality when it’s booting up inside Apache Tomcat allowing you to make changes to said module and begin testing. The same command, <code class="highlighter-rouge">bc</code>, can be used over and over again to run CAS locally and test the change until the desired functionality is there.</p>

<p>Once done, you may then commit the change to a relevant branch (of your fork, which is something you should have done earlier when you cloned the codebase) and push upstream (again, to your fork) in order to prepare a pull request and send in the change targetted at the right destination branch. More info on that workflow <a href="https://apereo.github.io/cas/developer/Contributor-Guidelines.html">is available here</a>.</p>

<h1 id="debugging-cas">Debugging CAS</h1>

<p>One of the very useful things you can include in your build is the ability to allow for remote debugging via <code class="highlighter-rouge">-DenableRemoteDebugging=true</code>. Both <a href="https://www.jetbrains.com/help/idea/run-debug-configuration-remote-debug.html">IntelliJ IDEA</a> and eclipse allow you ways to connect to a port remotely and activate a debugger in order to step into the code and troubleshoot. This is hugely useful, especially in cases where you can make a change to a source file and <em>rebuild</em> the component live hot-reloading the <code class="highlighter-rouge">.class</code> file to allow the changes to kick in the very next time execution passes through without restarting the servlet container. Depending on how significant the change is, this should save you quite a bit of time.</p>

<p>There are also much fancier tools such as <a href="https://zeroturnaround.com/software/jrebel/">JRebel</a> that let you do the same with a lot more power and flexibility.</p>

<p>The remote debugging port by default is <code class="highlighter-rouge">5000</code> and should be auto-incremented in case the port is busy or occupied by some other process. You should get notices and prompts from the build, if and when that happens.</p>

<p>A very useful flag that you may consider adding to your shell alias is <code class="highlighter-rouge">-DremoteDebuggingSuspend=true</code>, which allows you to suspend the JVM until a debugger tool is attached to the running process. This is handy in situations where you need to debug and troubleshoot a particular component or behavior that executes early during startup (i.e. fetching CAS configuration settings or servlet container bootstrapping) and you don’t want the runtime to proceed too quickly and forcing you to miss the troubleshooting window.</p>

<p>With the inclusion of this new flag, the build outcome sort of looks like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> Task :webapp:cas-server-webapp-tomcat:bootRun
Listening <span class="k">for </span>transport dt_socket at address: 5000
</code></pre></div></div>

<h1 id="overlay">Overlay</h1>

<p>Sometimes, it’s useful to test the new change from the perspective of the <a href="https://github.com/apereo/cas-overlay-template">CAS Overlay</a>. While the behavior should be identical, this step can be used in quick smoke tests and to ensure the proper set of dependencies and modules are published and <em>installed</em> correctly and picked up by the overlay build process without any conflicts or duplicates.</p>

<p>To publish and <em>install</em> CAS artifacts locally, you may try the following:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Build CAS and install...</span>
<span class="nb">alias </span><span class="nv">bci</span><span class="o">=</span><span class="s1">'clear; cd ~/Workspace/cas \
    ./gradlew clean build install --configure-on-demand --build-cache --parallel \
    -x test -x javadoc -x check -DenableRemoteDebugging=true --stacktrace \
    -DskipNestedConfigMetadataGen=true -DskipGradleLint=true -DskipSass=true \
    -DskipNodeModulesCleanUp=true -DskipNpmCache=true \
    -DskipNpmLint=true -DskipBootifulArtifact=true'</span>
</code></pre></div></div>

<p>Be patient. This might take some time.</p>

<p>A rather important flag in the above build is <code class="highlighter-rouge">-DskipBootifulArtifact=true</code>. This stops the Gradle build from applying the Spring Boot plugin to bootify application components, mainly the various CAS web application artifacts. This is required because the <a href="https://github.com/apereo/cas-overlay-template">CAS Overlay</a> needs to operate on a <em>vanilla</em> web application untouched by Spring Boot plugins (a.k.a <em>non-bootiful</em>) before it can explode and repackage it with Spring Boot. Note that the CAS build and release processes automatically take this flag into account when snapshots or releases are published and more conveniently, whether you are working on the CAS codebase or overlay, you get to work with the same bootiful web application without any extra hassle.</p>

<p>Once the artifacts are successfully installed, you can pick up the <code class="highlighter-rouge">-SNAPSHOT</code> artifacts in overlay by changing the CAS version and resume testing.</p>

<h1 id="writing-tests">Writing Tests</h1>

<p>Ideally, changes that are introduced need to be tested using either simple unit tests or integration tests.</p>

<h2 id="unit-tests">Unit Tests</h2>

<p>Writing unit tests is rather easy. If you have added a few changes to <code class="highlighter-rouge">src/main/java/org/apereo/cas/SomeCasComponent.java</code>, you will need to create the corresponding test component under <code class="highlighter-rouge">src/test/java/org/apereo/cas/SomeCasComponentTests.java</code> for the build to identify and execute it. The outline of <code class="highlighter-rouge">SomeCasComponentTests</code> would look something like this:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">junit</span><span class="o">.</span><span class="na">Assert</span><span class="o">.*;</span>

<span class="nd">@SpringBootTest</span><span class="o">(</span><span class="n">classes</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">SomeCasComponentConfiguration</span><span class="o">.</span><span class="na">class</span>
<span class="o">})</span>
<span class="nd">@TestPropertySource</span><span class="o">(</span><span class="n">properties</span> <span class="o">=</span> <span class="o">{</span><span class="s">"cas.some.property=value"</span><span class="o">})</span>
<span class="nd">@EnableConfigurationProperties</span><span class="o">(</span><span class="n">CasConfigurationProperties</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SomeCasComponentTests</span> <span class="o">{</span>
    <span class="nd">@ClassRule</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">SpringClassRule</span> <span class="n">SPRING_CLASS_RULE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SpringClassRule</span><span class="o">();</span>

    <span class="nd">@Rule</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">ConditionalIgnoreRule</span> <span class="n">conditionalIgnoreRule</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConditionalIgnoreRule</span><span class="o">();</span>

    <span class="nd">@Rule</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">SpringMethodRule</span> <span class="n">springMethodRule</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SpringMethodRule</span><span class="o">();</span>

    <span class="nd">@Rule</span>
    <span class="kd">public</span> <span class="n">ExpectedException</span> <span class="n">thrown</span> <span class="o">=</span> <span class="n">ExpectedException</span><span class="o">.</span><span class="na">none</span><span class="o">();</span>

    <span class="cm">/*
        Injected via SomeCasComponentConfiguration...
    */</span>
    <span class="nd">@Autowired</span>
    <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"someCasComponent"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">SomeCasComponent</span> <span class="n">someCasComponent</span><span class="o">;</span>

    <span class="nd">@Before</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">()</span> <span class="o">{</span>

    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">verifyStuffHappens</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// Invoke someCasComponent.someMethod() and examine/assert the output</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>In short, you need to make sure all the correct <em>Configuration</em> classes are included to bootstrap the build so that the required objects can be injected into the test class at runtime. You may also need to include additional modules and dependencies in the <code class="highlighter-rouge">build.gradle</code> file of the project to make sure the test runner has access to all required classes:</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dependencies</span> <span class="o">{</span>
    <span class="n">testImplementation</span> <span class="nf">project</span><span class="o">(</span><span class="s2">":support:cas-server-support-xyz"</span><span class="o">)</span>
    <span class="n">testImplementation</span> <span class="nf">project</span><span class="o">(</span><span class="nl">path:</span> <span class="s2">":support:cas-server-support-xyz"</span><span class="o">,</span> <span class="nl">configuration:</span> <span class="s2">"tests"</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>For best examples, scan the codebase to find similar test classes and try to follow the same pattern and structure as others to keep things as consistent as possible.</p>

<h2 id="integration-tests">Integration Tests</h2>

<p>If the change you are working on has a dependency on an external system such as a REST API or SQL database, you will need to make sure the test class is categorized appropriately. For example, let’s assume that <code class="highlighter-rouge">SomeCasComponentTests</code> requires an external Redis NoSQL database which means that your test class should indicate this as such:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Category</span><span class="o">(</span><span class="n">RedisCategory</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@ConditionalIgnore</span><span class="o">(</span><span class="n">condition</span> <span class="o">=</span> <span class="n">RunningContinuousIntegrationCondition</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SomeCasComponentTests</span> <span class="o">{</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Note that the test execution would always fail if the Redis database isn’t installed, running and configured correctly for everyone else working on the same CAS codebase. To work around this, we have also added a condition for the test runner to only execute the test when the <a href="https://travis-ci.org/apereo/cas/builds">CAS CI environment</a> is handling the test execution. The CI environment, given the appropriate category, will bootstrap and initialize the required dependencies and systems (typically via Docker) for the tests to execute which allows you to run the tests locally with a (Redis) database of your own while allowing the CI process to handle the test execution all the same, automatically and with the needed external dependencies.</p>

<p>Again, for better examples simply scan the codebase to find similar test classes.</p>

<h1 id="running-tests">Running Tests</h1>

<p>Our Gradle test commands need to be slightly modified to only run the tests that need to run based on the category of interest. For example, to run all Redis-related tests our test command would look like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>clear
<span class="nb">cd</span> ~/Workspace/cas
./gradlew clean testRedis <span class="nt">-x</span> <span class="nb">test</span> <span class="nt">-x</span> javadoc <span class="se">\</span>
    <span class="nt">--build-cache</span> <span class="nt">--configure-on-demand</span> <span class="nt">-DtestCategoryType</span><span class="o">=</span>REDIS
    <span class="nt">-x</span> check <span class="nt">--parallel</span> <span class="nt">-DskipNestedConfigMetadataGen</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
    <span class="nt">-DskipNestedConfigMetadataGen</span><span class="o">=</span><span class="nb">true</span> <span class="nt">-DskipSass</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
    <span class="nt">-DskipNodeModulesCleanUp</span><span class="o">=</span><span class="nb">true</span> <span class="nt">-DskipNpmCache</span><span class="o">=</span><span class="nb">true</span><span class="s1">'
</span></code></pre></div></div>

<p>Or, to run simple unit tests our test command would look like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>clear
<span class="nb">cd</span> ~/Workspace/cas
./gradlew clean <span class="nb">test</span> <span class="nt">-x</span> javadoc <span class="se">\</span>
    <span class="nt">--build-cache</span> <span class="nt">--configure-on-demand</span> <span class="nt">-DtestCategoryType</span><span class="o">=</span>SIMPLE
    <span class="nt">-x</span> check <span class="nt">--parallel</span> <span class="nt">-DskipNestedConfigMetadataGen</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
    <span class="nt">-DskipNestedConfigMetadataGen</span><span class="o">=</span><span class="nb">true</span> <span class="nt">-DskipSass</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
    <span class="nt">-DskipNodeModulesCleanUp</span><span class="o">=</span><span class="nb">true</span> <span class="nt">-DskipNpmCache</span><span class="o">=</span><span class="nb">true</span><span class="s1">'
</span></code></pre></div></div>

<p>Note the use of the <code class="highlighter-rouge">testCategoryType</code> parameter as well as the actual task that runs the tests (<code class="highlighter-rouge">test</code> vs <code class="highlighter-rouge">testRedis</code>). To learn more about other available categories and how they are executed, please <a href="https://github.com/apereo/cas/tree/6.0.x/ci/tests">take a look here</a>.</p>

<div class="alert alert-info">
<strong>But it works on my machine...</strong><br />Ultimately, all tests need to execute and pass on the CAS CI environment. There are the occasional phantom and unrelated failures which can usually be safely ignored but the canonical reference for tests and verifications is always the CI environment. When you write tests, try not to make assumptions that would later fail when the test is examined by CI.</div>

<h1 id="so">So…</h1>

<p>I hope this review was of some help to you and I am sure that both this post as well as the functionality it attempts to explain can be improved in any number of ways. Please feel free to <a href="https://apereo.github.io/cas/developer/Contributor-Guidelines.html">engage and contribute</a> as best as you can.</p>

<p>Happy Coding,</p>

<p><a href="https://twitter.com/misagh84">Misagh Moayyed</a></p>

<p>[1] There are ways to get around this <em>limitation</em>, by specifically downloading the source code for the exact CAS version at hand. I am skipping over those since they only lead to complications, suffering and further evil in most cases.</p>


</article>


  <div class="share-page">
  Share this post!

  <div class="share-links">
    
      <a class="fa fa-facebook" href="https://facebook.com/sharer.php?u=https%3A%2F%2Fapereo.github.io%2F2018%2F11%2F20%2Fcas60x-codebase-feature-build%2F" rel="nofollow" target="_blank" title="Share on Facebook"></a>
    

    
      <a class="fa fa-twitter" href="https://twitter.com/intent/tweet?text=Apereo+CAS+6.0.x+-+Building+CAS+Feature+Modules&amp;url=https%3A%2F%2Fapereo.github.io%2F2018%2F11%2F20%2Fcas60x-codebase-feature-build%2F" rel="nofollow" target="_blank" title="Share on Twitter"></a>
    

    
      <a class="fa fa-google-plus" href="https://plus.google.com/share?url=https%3A%2F%2Fapereo.github.io%2F2018%2F11%2F20%2Fcas60x-codebase-feature-build%2F" rel="nofollow" target="_blank" title="Share on Google+"></a>
    

    
      <a class="fa fa-linkedin" href="http://www.linkedin.com/shareArticle?url=https%3A%2F%2Fapereo.github.io%2F2018%2F11%2F20%2Fcas60x-codebase-feature-build%2F&amp;title=Apereo+CAS+6.0.x+-+Building+CAS+Feature+Modules" rel="nofollow" target="_blank" title="Share on LinkedIn"></a>
    

    
      <a class="fa fa-digg" href="http://digg.com/submit?url=https%3A%2F%2Fapereo.github.io%2F2018%2F11%2F20%2Fcas60x-codebase-feature-build%2F&amp;title=Apereo+CAS+6.0.x+-+Building+CAS+Feature+Modules" rel="nofollow" target="_blank" title="Share on Digg"></a>
    

    
      <a class="fa fa-tumblr" href="http://www.tumblr.com/share/link?url=https%3A%2F%2Fapereo.github.io%2F2018%2F11%2F20%2Fcas60x-codebase-feature-build%2F&amp;name=Apereo+CAS+6.0.x+-+Building+CAS+Feature+Modules" rel="nofollow" target="_blank" title="Share on Tumblr"></a>
    

    
      <a class="fa fa-reddit" href="http://reddit.com/submit?url=https%3A%2F%2Fapereo.github.io%2F2018%2F11%2F20%2Fcas60x-codebase-feature-build%2F&amp;title=Apereo+CAS+6.0.x+-+Building+CAS+Feature+Modules" rel="nofollow" target="_blank" title="Share on Reddit"></a>
    

    
      <a class="fa fa-stumbleupon" href="http://www.stumbleupon.com/submit?url=https%3A%2F%2Fapereo.github.io%2F2018%2F11%2F20%2Fcas60x-codebase-feature-build%2F&amp;title=Apereo+CAS+6.0.x+-+Building+CAS+Feature+Modules" rel="nofollow" target="_blank" title="Share on StumbleUpon"></a>
    

    
      <a class="fa fa-hacker-news" onclick="parent.postMessage('submit','*')" href="https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fapereo.github.io%2F2018%2F11%2F20%2Fcas60x-codebase-feature-build%2F&amp;t=Apereo+CAS+6.0.x+-+Building+CAS+Feature+Modules" rel="nofollow" target="_blank" title="Share on Hacker News"></a>
    
  </div>
</div>




  <div class="py2 post-footer">
  <!-- <img src="/images/me.jpeg" alt="John Otander" class="avatar" /> -->

  <p>
    Follow Apereo on <a href="https://twitter.com/Apereo">Twitter</a>.
  </p>
</div>










  <h3 class="related-post-title">Related Posts</h3>
  
    <div class="post ml2">
      <a href="/2019/02/01/610rc1-release/" class="post-link">
        <h4 class="post-title">CAS 6.1.0 RC1 Feature Release</h4>
        <p class="post-summary">...in which I present an overview of CAS 6.1.0 RC1 release.</p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2018/12/24/cas53-oohlalamobile-saml2-integration/" class="post-link">
        <h4 class="post-title">Apereo CAS - OohLala Mobile SAML2 Integration</h4>
        <p class="post-summary">Learn how to integrate OohLala Mobile with Apereo CAS running as a SAML2 identity provider.</p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2018/12/24/cas53-oclc-saml2-integration/" class="post-link">
        <h4 class="post-title">Apereo CAS - Cranium Cafe SAML2 Integration</h4>
        <p class="post-summary">Learn how to integrate Cranium Cafe with Apereo CAS running as a SAML2 identity provider.</p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2018/12/24/cas53-elumen-saml2-integration/" class="post-link">
        <h4 class="post-title">Apereo CAS - eLumen SAML2 Integration</h4>
        <p class="post-summary">Learn how to integrate eLumen with Apereo CAS running as a SAML2 identity provider.</p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2018/12/23/cas53-getrave-saml2-integration/" class="post-link">
        <h4 class="post-title">Apereo CAS - Rave SAML2 Integration</h4>
        <p class="post-summary">Learn how to integrate Rave with Apereo CAS running as a SAML2 identity provider.</p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2018/12/22/cas53-hiretouch-saml2-integration/" class="post-link">
        <h4 class="post-title">Apereo CAS - HireTouch SAML2 Integration</h4>
        <p class="post-summary">Learn how to integrate HireTouch with Apereo CAS running as a SAML2 identity provider.</p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2018/12/06/cas53-office365-saml2-integration/" class="post-link">
        <h4 class="post-title">Apereo CAS - Microsoft Office 365 SAML2 Integration</h4>
        <p class="post-summary">Learn how to integrate Microsoft Office 365 with Apereo CAS running as a SAML2 identity provider.</p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2018/12/04/cas53-happyfox-saml2-integration/" class="post-link">
        <h4 class="post-title">Apereo CAS - HappyFox SAML2 Integration</h4>
        <p class="post-summary">Learn how to integrate HappyFox with Apereo CAS running as a SAML2 identity provider.</p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2018/12/04/cas53-cisco-webex-saml2-integration/" class="post-link">
        <h4 class="post-title">Apereo CAS - Cisco Webex SAML2 Integration</h4>
        <p class="post-summary">Learn how to integrate Cisco Webex with Apereo CAS running as a SAML2 identity provider.</p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2018/12/03/cas53-vmwareidentitymgr-saml2-integration/" class="post-link">
        <h4 class="post-title">Apereo CAS - VMware Identity Manager SAML2 Integration</h4>
        <p class="post-summary">Learn how to integrate VMware Identity Manager with Apereo CAS running as a SAML2 identity provider.</p>
      </a>
    </div>
  


      </div>
    </div>
  </div>

  <footer class="center">
  <div class="measure">
    <small>
      Theme crafted with &lt;3 by <a href="http://johnotander.com">John Otander</a> (<a href="https://twitter.com/4lpine">@4lpine</a>).<br>
      &lt;/&gt; available on <a href="https://github.com/johnotander/pixyll">Github</a>.
    </small>
  </div>

          
</footer>
<!-- AnchorJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.0.0/anchor.min.js"></script>
<script>
    anchors.options.visible = 'always';
    anchors.add('article h1, article h2, article h3, article h4, article h5, article h6');
</script>

	
</body>
</html>
