<!DOCTYPE html>
<html>
<head>
    
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MZG9L7');</script>
    
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>JWT Of All Things With CAS &#8211; Apereo Community Blog</title>
    <link rel="dns-prefetch" href="//maxcdn.bootstrapcdn.com">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="A short tutorial on how to let Apereo CAS handle authentication events accompanied by JWTs.">
    <meta name="robots" content="all">
    <meta name="author" content="Apereo Project Participants">
    
    <meta name="keywords" content="">
    <link rel="canonical" href="https://apereo.github.io/2017/10/17/cas-jwt-authn-with-duo/">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for Apereo Community Blog" href="/feed.xml" />

    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css"
          integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd"
          crossorigin="anonymous">

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/tether/1.3.7/js/tether.min.js"></script>
    
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/js/bootstrap.min.js"
            integrity="sha384-vZ2WRJMwsjRMW/8U7i6PWi6AlO1L79snBrmgiDpgIWJ82z8eA5lenwvxbMV1PAh7"
            crossorigin="anonymous"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/pixyll.css?202303081604" type="text/css">

    <!-- Fonts -->
    
    <link href='//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Lato:900,300&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    
    
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet">
    

    <!-- MathJax -->
    
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js??config=TeX-AMS-MML_HTMLorMML">
    </script>
    

    <!-- Verifications -->
    
    

    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:title" content="JWT Of All Things With CAS">
    <meta property="og:description" content="This is a blog managed and edited by the Apereo project participants. It is typically used to post project updates, announce news, etc.">
    <meta property="og:url" content="https://apereo.github.io/2017/10/17/cas-jwt-authn-with-duo/">
    <meta property="og:site_name" content="Apereo Community Blog">
    
    <meta property="og:image" content="https://apereo.github.io/images/me.jpeg">
    

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    
        <meta name="twitter:site" content="@Apereo" />
        <meta name="twitter:creator" content="@Apereo" />
    
    <meta name="twitter:title" content="JWT Of All Things With CAS" />
    <meta name="twitter:description" content="A short tutorial on how to let Apereo CAS handle authentication events accompanied by JWTs." />
    <meta name="twitter:url" content="https://apereo.github.io/2017/10/17/cas-jwt-authn-with-duo/" />
    
    <meta name="twitter:image" content="https://apereo.github.io/images/me.jpeg" />
    

    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">

    
    <script type="text/javascript">
       (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
       ga('create', 'UA-83384532-1', 'auto');
       ga('send', 'pageview');
    </script>
    

    
    
</head>

<body class="site animated fade-in-down">
  

  <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MZG9L7"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-MZG9L7');</script>
  
  
	

  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="https://apereo.github.io" class="site-title">Apereo Community Blog</a>
      <nav class="site-nav">
        



    
    
    
    
        <a href="/about/">About</a>
    

    

    
    
    
    
        <a href="/contact/">Say Hello</a>
    

    

    
    
    
    
        <a href="/tags/">All Posts</a>
    

    

    
    
    
    
        <a href="/search/">Search</a>
    

    


      </nav>
      <div class="clearfix"></div>
      
        <div class="social-icons">
  <div class="social-icons-right">
    
      <a class="fa fa-github" href="https://github.com/apereo"></a>
    
    
    
    
    <a class="fa fa-rss" href="/feed.xml"></a>
    
      <a class="fa fa-twitter" href="https://twitter.com/Apereo"></a>
    
    
    
    
    
      <a class="fa fa-envelope" href="mailto:info@apereo.org"></a>
    
    
    
    
    
    
  </div>
  <div class="right">
    
    
    
  </div>
</div>
<div class="clearfix"></div>

      
    </div>
  </div>
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<div class="post-header mb2">
  <h1>JWT Of All Things With CAS</h1>
  <span class="post-meta">Tuesday, Oct 17, 2017</span><br>
  
  <span class="post-meta small">
  
    9 minute read
  
  </span>
</div>

<article class="post-content">
  <!--
<div class="alert alert-danger">
  <strong>WATCH OUT!</strong><br/>This post is not official yet and may be heavily edited as CAS development makes progress. <a href="https://apereo.github.io/feed.xml">Watch</a> for further updates.
</div>
-->

<div class="alert alert-success">
  <strong>Collaborate</strong><br />The blog is managed and hosted on GitHub. If you wish to update the contents of this post or if you have found an inaccuracy and wish to make corrections, we recommend that you please submit a pull request to <a href="https://github.com/apereo/apereo.github.io">this repository</a>.
</div>

<p>Apereo CAS has had built-in support for <a href="https://jwt.io/">JWTs</a> for some time now in a variety of different ways. Notions of JWT support really date back to CAS <code class="highlighter-rouge">3.5.x</code> with the work <a href="https://github.com/epierce/cas-server-extension-token">@epierce</a> did as a CAS extension to enable token authentication support. Since then, support for JWTs has significantly improved and grown over the years and continues to get better with an emerging number of use cases whose chief concern is improving performance and removing round-trip calls, among other things.</p>

<p>In this tutorial, I am going to briefly review various forms of JWT functionality in CAS. Specifically, the following topics will be reviewed:</p>

<ul>
  <li><a href="https://apereo.github.io/cas/development/installation/JWT-Authentication.html">JWT Authentication</a>: Allowing CAS to accept JWTs as credentials in non-interactive authentication modes mostly.</li>
  <li>JWTs with <a href="https://apereo.github.io/cas/development/installation/DuoSecurity-Authentication.html">Duo Security Multifactor Authentication</a>: Exploring an approach where a non-interactive authentication request may be routed to a multifactor authentication flow and back.</li>
  <li><a href="https://apereo.github.io/cas/development/installation/Configure-ServiceTicket-JWT.html">JWTs as Service Tickets</a>: Allowing CAS to transform service tickets issued for applications into JWTs.</li>
</ul>

<h1 id="environment">Environment</h1>

<ul>
  <li>Apereo CAS <code class="highlighter-rouge">5.2.0-SNAPSHOT</code></li>
  <li>curl <code class="highlighter-rouge">7.54.0</code></li>
</ul>

<p>…and last but not least, a functional vanilla CAS overlay. For this tutorial, I am using the <a href="https://github.com/apereo/cas-overlay-template">CAS Maven WAR Overlay</a> project.</p>

<h1 id="jwt-authentication">JWT Authentication</h1>

<p>CAS provides support for token-based authentication on top of JWTs, where an authentication request can be granted an SSO session based on a form of credentials that are JWTs. CAS expects a <code class="highlighter-rouge">token</code> parameter (or request header) to be passed along to the <code class="highlighter-rouge">/login</code> endpoint as the credential. The parameter value must of course be a JWT.</p>

<h2 id="let-there-be-jwt">Let There Be JWT</h2>

<p>To generate a JWT, I ended up using the <a href="https://apereo.github.io/cas/development/installation/Configuring-Commandline-Shell.html">CAS Command-line Shell</a>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>cas-overlay-template
./build.sh cli <span class="nt">-sh</span>
</code></pre></div></div>

<p>This will allow you to enter the interactive shell, where you have documentation, tab-completion and history for all commands.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Welcome to CAS Command-line Shell. For assistance press or <span class="nb">type</span> <span class="s2">"help"</span> <span class="k">then </span>hit ENTER.
cas&gt;

cas&gt;generate-jwt <span class="nt">--subject</span> Misagh

<span class="o">====</span> Signing Secret <span class="o">====</span>
MY4Jpxr5VeZsJ...

<span class="o">====</span> Encryption Secret <span class="o">====</span>
MZCjxBbDFq9cHPdy...

Generating JWT <span class="k">for </span>subject <span class="o">[</span>Misagh] with signing key size <span class="o">[</span>256], signing algorithm <span class="o">[</span>HS256],
    encryption key size <span class="o">[</span>48], encryption method <span class="o">[</span>A192CBC-HS384] and encryption algorithm <span class="o">[</span>dir]

<span class="o">====</span> JWT <span class="o">====</span>
eyJjdHkiOiJKV1QiLCJ...
</code></pre></div></div>

<p>Hooray! We have a JWT.</p>

<p>There are a variety of other parameters such as encryption methods and signing algorithms you can choose from to generate the JWT. For the purposes of this tutorial, let’s keep things simple. Of course, you don’t have to use the CAS command-line shell. Any valid compliant JWT generator would do fine.</p>

<div class="alert alert-info">
  <strong>Don't Take Things Literally</strong><br />I am abbreviating the secrets and the generated JWT above. Do NOT copy paste these into your environment and configuration, thinking they might do the trick.
</div>

<h2 id="configure-application">Configure Application</h2>

<p>CAS <a href="https://apereo.github.io/cas/development/installation/JWT-Authentication.html">needs to be taught</a> the security properties of the JWT to unpack and validate it and produce the relevant authenticated session. For a given authentication request, CAS will try to find the matching record for the application in its registry that is capable of validating JWTs. If such a record is found and the request is in fact accompanied by JWT credentials, the credential is validated and the service ticket issued.</p>

<p>My CAS overlay is already equipped with the <a href="https://apereo.github.io/cas/development/installation/JWT-Authentication.html">relevant configuration module</a> and my application record using <a href="https://apereo.github.io/cas/development/installation/JSON-Service-Management.html">the JSON service registry</a> looks something like this:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"@class"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"org.apereo.cas.services.RegexRegisteredService"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"serviceId"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"https://www.example.org"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Example"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"id"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w">
  </span><span class="s2">"properties"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"@class"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"java.util.HashMap"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"jwtSigningSecret"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"@class"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"org.apereo.cas.services.DefaultRegisteredServiceProperty"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"values"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"java.util.HashSet"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"MY4Jpxr5VeZsJ..."</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"jwtEncryptionSecret"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"@class"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"org.apereo.cas.services.DefaultRegisteredServiceProperty"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"values"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"java.util.HashSet"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"MZCjxBbDFq9cHPdy..."</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Now, we are ready to start sending requests.</p>

<h2 id="authenticate">Authenticate</h2>

<p>Using <code class="highlighter-rouge">curl</code> from a terminal, here is the authentication sequence:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-i</span> <span class="s2">"https://mmoayyed.example.net/cas/login?service=https://www.example.org&amp;token=eyJjdHkiOiJKV1QiLCJ..."</span>

HTTP/1.1 302
...
Location: https://www.example.org?ticket<span class="o">=</span>ST-1-zmEt1zfAuHv9vG6DogfBeH5ylmc-mmoayyed-4
...
</code></pre></div></div>

<p>A few things to note:</p>

<ul>
  <li>The <code class="highlighter-rouge">-i</code> option allows <code class="highlighter-rouge">curl</code> to output the response headers where <code class="highlighter-rouge">Location</code> in the above case contains the redirect URL with the issued service ticket.</li>
  <li>The entire url in the <code class="highlighter-rouge">curl</code> command in encased in double-quotes. This is necessary for <code class="highlighter-rouge">curl</code> to ensure the query string is entirely passed along to CAS.</li>
</ul>

<p>Of course, I can pass the JWT as a request header too:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-i</span> <span class="s2">"https://mmoayyed.example.net/cas/login?service=https://www.example.org"</span> <span class="nt">--header</span> <span class="s2">"token:eyJjdHkiOiJKV1QiLCJ..."</span>

HTTP/1.1 302
...
Location: https://www.example.org?ticket<span class="o">=</span>ST-1-qamgyzfAuHv9vG6DogfBeH5ylmc-mmoayyed-4
...
</code></pre></div></div>

<p>Grab the <code class="highlighter-rouge">ticket</code> from the <code class="highlighter-rouge">Location</code> header and proceed to validate it, as you would any regular service ticket.</p>

<h1 id="duo-security-mfa-with-jwts">Duo Security MFA With JWTs</h1>

<p>I want to be able to use my JWT to authenticate with CAS and get a service ticket issued to my application at <code class="highlighter-rouge">https://www.example.org</code>, but I also want the request to be verified via second-factor credentials and an MFA flow provided by Duo Security. How do I do that?</p>

<p><a href="https://apereo.github.io/cas/development/installation/DuoSecurity-Authentication.html">Duo Security integration support</a> of CAS is able to also support non-browser based multifactor authentication requests. In order to trigger this behavior, applications (i.e. <code class="highlighter-rouge">curl</code>, REST APIs, etc.) need to specify a special <code class="highlighter-rouge">Content-Type</code> to signal to CAS that the request is submitted from a non-web based environment. The multifactor authentication request is submitted to Duo Security in <code class="highlighter-rouge">auto</code> mode which effectively may translate into an out-of-band factor (push or phone) recommended by Duo as the best for the user’s devices.</p>

<div class="alert alert-warning">
  <strong>YMMV</strong><br />If you are using a different kind of multifactor authentication provider, you will need to verify whether it's able to support such behaviors.
</div>

<h2 id="configure-duo-security">Configure Duo Security</h2>

<p>My overlay is prepped with the <a href="https://apereo.github.io/cas/development/installation/DuoSecurity-Authentication.html">relevant configuration module</a> of course and settings that include integration keys, secret keys, etc.</p>

<h2 id="application-mfa-trigger">Application MFA Trigger</h2>

<p>I am also going to configure <a href="https://apereo.github.io/cas/development/installation/Configuring-Multifactor-Authentication-Triggers.html#applications">an application-based trigger</a> for <code class="highlighter-rouge">https://www.example.org</code> so that authentication requests are routed to the relevant multifactor authentication provider.</p>

<p>So my application record will take on the following form:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"@class"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"org.apereo.cas.services.RegexRegisteredService"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"serviceId"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"https://www.example.org"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Example"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"id"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w">
  </span><span class="s2">"multifactorPolicy"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"@class"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"org.apereo.cas.services.DefaultRegisteredServiceMultifactorPolicy"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"multifactorAuthenticationProviders"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"java.util.LinkedHashSet"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"mfa-duo"</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="s2">"properties"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"@class"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"java.util.HashMap"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"jwtSigningSecret"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"@class"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"org.apereo.cas.services.DefaultRegisteredServiceProperty"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"values"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"java.util.HashSet"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"MY4Jpxr5VeZsJ..."</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"jwtEncryptionSecret"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"@class"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"org.apereo.cas.services.DefaultRegisteredServiceProperty"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"values"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"java.util.HashSet"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"MZCjxBbDFq9cHPdy..."</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="authenticate-1">Authenticate</h2>

<p>Using <code class="highlighter-rouge">curl</code> again from a terminal, here is the authentication sequence:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-i</span> <span class="s2">"https://mmoayyed.example.net/cas/login?service=https://www.example.org"</span>
    <span class="nt">--header</span> <span class="s2">"token:eyJjdHkiOiJKV1QiLCJ..."</span> <span class="nt">--header</span> <span class="s2">"Content-Type: application/cas"</span>

HTTP/1.1 302
...
Location: https://www.example.org?ticket<span class="o">=</span>ST-1-gdfe1zfAuHv9vG6DogfBeH5ylmc-mmoayyed-4
...
</code></pre></div></div>

<p>Things work exactly the same as before, except that this time your device registered with Duo Security will receive a  notification where your approval will authorize CAS to establish a session and generate a ticket.</p>

<h1 id="jwt-service-tickets">JWT Service Tickets</h1>

<p>All operations so far have issued a regular service ticket back to the application that must be validated in a subsequent trip so the application can retrieve the authenticated user profile. In a different variation, it’s possible for the service ticket itself to <a href="https://apereo.github.io/cas/development/installation/Configure-ServiceTicket-JWT.html">take on the form of a JWT</a>. JWT-based service tickets are issued to applications based on the same semantics defined by the CAS Protocol. CAS having received an authentication request via its <code class="highlighter-rouge">/login</code> endpoint will conditionally issue back JWT service tickets to the application in form of a <code class="highlighter-rouge">ticket</code> parameter via the requested http method.</p>

<div class="alert alert-info">
  <strong>Let's REST</strong><br />In case you are using the CAS REST APIs, you should know that service tickets issued as part of REST API operations <a href="https://apereo.github.io/cas/development/protocol/REST-Protocol.html#jwt-service-tickets">may also be JWTs</a>.
</div>

<h2 id="configure-jwts">Configure JWTs</h2>

<p>In order for CAS to transform service tickets into JWTs, essentially we need to execute the reverse of the above configuration steps. We will need to ensure CAS is provided with relevant keys to generate JWTs and these keys are in turn used by the application to unpack the <em>JWTness</em> of generated service ticket.</p>

<p>The overlay also needs to be equipped with <a href="https://apereo.github.io/cas/development/installation/Configure-ServiceTicket-JWT.html">the relevant extension module</a> of course to allow for this functionality.</p>

<p>You may generate the required secrets manually per the above link. In this example, I left them undefined in my properties which forces CAS to generate a few on its own and warn me about them when it starts up:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>... - &lt;Secret key <span class="k">for </span>encryption is not defined <span class="k">for</span> <span class="o">[</span>Token/JWT Tickets]<span class="p">;</span> 
    CAS will attempt to auto-generate the encryption key&gt;
... - &lt;Generated encryption key <span class="o">[</span>...] of size <span class="o">[</span>256] <span class="k">for</span> <span class="o">[</span>Token/JWT Tickets]. 
    The generated key MUST be added to CAS settings under setting <span class="o">[</span>cas.authn.token.crypto.encryption.key].&gt;
... - &lt;Secret key <span class="k">for </span>signing is not defined <span class="k">for</span> <span class="o">[</span>Token/JWT Tickets]. 
    CAS will attempt to auto-generate the signing key&gt;
... - &lt;Generated signing key <span class="o">[</span>...] of size <span class="o">[</span>512] <span class="k">for</span> <span class="o">[</span>Token/JWT Tickets]. 
    The generated key MUST be added to CAS settings under setting <span class="o">[</span>cas.authn.token.crypto.signing.key].&gt;
</code></pre></div></div>

<p>Fine! Let’s proceed.</p>

<h2 id="configure-application-1">Configure Application</h2>

<p>JWTs as service tickets are issued on a per-application basis. This means that once CAS finds a matching record for the application in its registry, it will try to determine if the application requires JWTs as service tickets. So my application record will take on the following form:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"@class"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"org.apereo.cas.services.RegexRegisteredService"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"serviceId"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"https://www.example.org"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Example"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"id"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w">
  </span><span class="s2">"multifactorPolicy"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"@class"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"org.apereo.cas.services.DefaultRegisteredServiceMultifactorPolicy"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"multifactorAuthenticationProviders"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"java.util.LinkedHashSet"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"mfa-duo"</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="s2">"properties"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"@class"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"java.util.HashMap"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"jwtSigningSecret"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"@class"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"org.apereo.cas.services.DefaultRegisteredServiceProperty"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"values"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"java.util.HashSet"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"MY4Jpxr5VeZsJ..."</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"jwtEncryptionSecret"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"@class"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"org.apereo.cas.services.DefaultRegisteredServiceProperty"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"values"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"java.util.HashSet"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"MZCjxBbDFq9cHPdy..."</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"jwtAsResponse"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"@class"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"org.apereo.cas.services.DefaultRegisteredServiceProperty"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"values"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"java.util.HashSet"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"true"</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Now, we are ready to start sending requests.</p>

<h2 id="authenticate-2">Authenticate</h2>

<p>Using <code class="highlighter-rouge">curl</code> again from a terminal, here is the authentication sequence:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-i</span> <span class="s2">"https://mmoayyed.example.net/cas/login?service=https://www.example.org"</span> 
    <span class="nt">--header</span> <span class="s2">"token:eyJjdHkiOiJKV1QiLCJ..."</span> <span class="nt">--header</span> <span class="s2">"Content-Type: application/cas"</span>

HTTP/1.1 302
...
Location: https://www.example.org?ticket<span class="o">=</span>eyJhbGciOiJIUzUxMiJ9.WlhsS05tRllRV2xQYVVwRlVsV...
...
</code></pre></div></div>

<p>This works exactly the same as before, except that now the <code class="highlighter-rouge">ticket</code> parameter contains a JWT as a service ticket.</p>

<h1 id="summary">Summary</h1>

<p>I hope this tutorial was of some help to you. As you have been reading, I can guess that you have come up with a number of missing bits and pieces that would satisfy your JWT needs more comprehensively with CAS. In a way, that is exactly what this tutorial intends to inspire. Please feel free to <a href="https://apereo.github.io/cas/developer/Contributor-Guidelines.html">engage and contribute</a> as best as you can.</p>

<p><a href="https://twitter.com/misagh84">Misagh Moayyed</a></p>

</article>


  <div class="share-page">
  Share this post!

  <div class="share-links">
    
      <a class="fa fa-facebook" href="https://facebook.com/sharer.php?u=https%3A%2F%2Fapereo.github.io%2F2017%2F10%2F17%2Fcas-jwt-authn-with-duo%2F" rel="nofollow" target="_blank" title="Share on Facebook"></a>
    

    
      <a class="fa fa-twitter" href="https://twitter.com/intent/tweet?text=JWT+Of+All+Things+With+CAS&amp;url=https%3A%2F%2Fapereo.github.io%2F2017%2F10%2F17%2Fcas-jwt-authn-with-duo%2F" rel="nofollow" target="_blank" title="Share on Twitter"></a>
    

    
      <a class="fa fa-google-plus" href="https://plus.google.com/share?url=https%3A%2F%2Fapereo.github.io%2F2017%2F10%2F17%2Fcas-jwt-authn-with-duo%2F" rel="nofollow" target="_blank" title="Share on Google+"></a>
    

    
      <a class="fa fa-linkedin" href="http://www.linkedin.com/shareArticle?url=https%3A%2F%2Fapereo.github.io%2F2017%2F10%2F17%2Fcas-jwt-authn-with-duo%2F&amp;title=JWT+Of+All+Things+With+CAS" rel="nofollow" target="_blank" title="Share on LinkedIn"></a>
    

    
      <a class="fa fa-digg" href="http://digg.com/submit?url=https%3A%2F%2Fapereo.github.io%2F2017%2F10%2F17%2Fcas-jwt-authn-with-duo%2F&amp;title=JWT+Of+All+Things+With+CAS" rel="nofollow" target="_blank" title="Share on Digg"></a>
    

    
      <a class="fa fa-tumblr" href="http://www.tumblr.com/share/link?url=https%3A%2F%2Fapereo.github.io%2F2017%2F10%2F17%2Fcas-jwt-authn-with-duo%2F&amp;name=JWT+Of+All+Things+With+CAS" rel="nofollow" target="_blank" title="Share on Tumblr"></a>
    

    
      <a class="fa fa-reddit" href="http://reddit.com/submit?url=https%3A%2F%2Fapereo.github.io%2F2017%2F10%2F17%2Fcas-jwt-authn-with-duo%2F&amp;title=JWT+Of+All+Things+With+CAS" rel="nofollow" target="_blank" title="Share on Reddit"></a>
    

    
      <a class="fa fa-stumbleupon" href="http://www.stumbleupon.com/submit?url=https%3A%2F%2Fapereo.github.io%2F2017%2F10%2F17%2Fcas-jwt-authn-with-duo%2F&amp;title=JWT+Of+All+Things+With+CAS" rel="nofollow" target="_blank" title="Share on StumbleUpon"></a>
    

    
      <a class="fa fa-hacker-news" onclick="parent.postMessage('submit','*')" href="https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fapereo.github.io%2F2017%2F10%2F17%2Fcas-jwt-authn-with-duo%2F&amp;t=JWT+Of+All+Things+With+CAS" rel="nofollow" target="_blank" title="Share on Hacker News"></a>
    
  </div>
</div>




  <div class="py2 post-footer">
  <!-- <img src="/images/me.jpeg" alt="John Otander" class="avatar" /> -->

  <p>
    Follow Apereo on <a href="https://twitter.com/Apereo">Twitter</a>.
  </p>
</div>










  <h3 class="related-post-title">Related Posts</h3>
  
    <div class="post ml2">
      <a href="/2019/02/01/610rc1-release/" class="post-link">
        <h4 class="post-title">CAS 6.1.0 RC1 Feature Release</h4>
        <p class="post-summary">...in which I present an overview of CAS 6.1.0 RC1 release.</p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2018/12/24/cas53-oohlalamobile-saml2-integration/" class="post-link">
        <h4 class="post-title">Apereo CAS - OohLala Mobile SAML2 Integration</h4>
        <p class="post-summary">Learn how to integrate OohLala Mobile with Apereo CAS running as a SAML2 identity provider.</p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2018/12/24/cas53-oclc-saml2-integration/" class="post-link">
        <h4 class="post-title">Apereo CAS - Cranium Cafe SAML2 Integration</h4>
        <p class="post-summary">Learn how to integrate Cranium Cafe with Apereo CAS running as a SAML2 identity provider.</p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2018/12/24/cas53-elumen-saml2-integration/" class="post-link">
        <h4 class="post-title">Apereo CAS - eLumen SAML2 Integration</h4>
        <p class="post-summary">Learn how to integrate eLumen with Apereo CAS running as a SAML2 identity provider.</p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2018/12/23/cas53-getrave-saml2-integration/" class="post-link">
        <h4 class="post-title">Apereo CAS - Rave SAML2 Integration</h4>
        <p class="post-summary">Learn how to integrate Rave with Apereo CAS running as a SAML2 identity provider.</p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2018/12/22/cas53-hiretouch-saml2-integration/" class="post-link">
        <h4 class="post-title">Apereo CAS - HireTouch SAML2 Integration</h4>
        <p class="post-summary">Learn how to integrate HireTouch with Apereo CAS running as a SAML2 identity provider.</p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2018/12/06/cas53-office365-saml2-integration/" class="post-link">
        <h4 class="post-title">Apereo CAS - Microsoft Office 365 SAML2 Integration</h4>
        <p class="post-summary">Learn how to integrate Microsoft Office 365 with Apereo CAS running as a SAML2 identity provider.</p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2018/12/04/cas53-happyfox-saml2-integration/" class="post-link">
        <h4 class="post-title">Apereo CAS - HappyFox SAML2 Integration</h4>
        <p class="post-summary">Learn how to integrate HappyFox with Apereo CAS running as a SAML2 identity provider.</p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2018/12/04/cas53-cisco-webex-saml2-integration/" class="post-link">
        <h4 class="post-title">Apereo CAS - Cisco Webex SAML2 Integration</h4>
        <p class="post-summary">Learn how to integrate Cisco Webex with Apereo CAS running as a SAML2 identity provider.</p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2018/12/03/cas53-vmwareidentitymgr-saml2-integration/" class="post-link">
        <h4 class="post-title">Apereo CAS - VMware Identity Manager SAML2 Integration</h4>
        <p class="post-summary">Learn how to integrate VMware Identity Manager with Apereo CAS running as a SAML2 identity provider.</p>
      </a>
    </div>
  


      </div>
    </div>
  </div>

  <footer class="center">
  <div class="measure">
    <small>
      Theme crafted with &lt;3 by <a href="http://johnotander.com">John Otander</a> (<a href="https://twitter.com/4lpine">@4lpine</a>).<br>
      &lt;/&gt; available on <a href="https://github.com/johnotander/pixyll">Github</a>.
    </small>
  </div>

          
</footer>
<!-- AnchorJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.0.0/anchor.min.js"></script>
<script>
    anchors.options.visible = 'always';
    anchors.add('article h1, article h2, article h3, article h4, article h5, article h6');
</script>

	
</body>
</html>
