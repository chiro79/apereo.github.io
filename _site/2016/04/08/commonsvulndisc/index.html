<!DOCTYPE html>
<html>
<head>
    
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MZG9L7');</script>
    
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>CAS Vulnerability Disclosure &#8211; Apereo Community Blog</title>
    <link rel="dns-prefetch" href="//maxcdn.bootstrapcdn.com">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Disclosure of issue with the Apache Commons Collections">
    <meta name="robots" content="all">
    <meta name="author" content="Apereo Project Participants">
    
    <meta name="keywords" content="">
    <link rel="canonical" href="https://apereo.github.io/2016/04/08/commonsvulndisc/">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for Apereo Community Blog" href="/feed.xml" />

    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css"
          integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd"
          crossorigin="anonymous">

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/tether/1.3.7/js/tether.min.js"></script>
    
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/js/bootstrap.min.js"
            integrity="sha384-vZ2WRJMwsjRMW/8U7i6PWi6AlO1L79snBrmgiDpgIWJ82z8eA5lenwvxbMV1PAh7"
            crossorigin="anonymous"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/pixyll.css?202303081604" type="text/css">

    <!-- Fonts -->
    
    <link href='//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Lato:900,300&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    
    
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet">
    

    <!-- MathJax -->
    
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js??config=TeX-AMS-MML_HTMLorMML">
    </script>
    

    <!-- Verifications -->
    
    

    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:title" content="CAS Vulnerability Disclosure">
    <meta property="og:description" content="This is a blog managed and edited by the Apereo project participants. It is typically used to post project updates, announce news, etc.">
    <meta property="og:url" content="https://apereo.github.io/2016/04/08/commonsvulndisc/">
    <meta property="og:site_name" content="Apereo Community Blog">
    
    <meta property="og:image" content="https://apereo.github.io/images/me.jpeg">
    

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    
        <meta name="twitter:site" content="@Apereo" />
        <meta name="twitter:creator" content="@Apereo" />
    
    <meta name="twitter:title" content="CAS Vulnerability Disclosure" />
    <meta name="twitter:description" content="Disclosure of issue with the Apache Commons Collections" />
    <meta name="twitter:url" content="https://apereo.github.io/2016/04/08/commonsvulndisc/" />
    
    <meta name="twitter:image" content="https://apereo.github.io/images/me.jpeg" />
    

    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">

    
    <script type="text/javascript">
       (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
       ga('create', 'UA-83384532-1', 'auto');
       ga('send', 'pageview');
    </script>
    

    
    
</head>

<body class="site animated fade-in-down">
  

  <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MZG9L7"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-MZG9L7');</script>
  
  
	

  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="https://apereo.github.io" class="site-title">Apereo Community Blog</a>
      <nav class="site-nav">
        



    
    
    
    
        <a href="/about/">About</a>
    

    

    
    
    
    
        <a href="/contact/">Say Hello</a>
    

    

    
    
    
    
        <a href="/tags/">All Posts</a>
    

    

    
    
    
    
        <a href="/search/">Search</a>
    

    


      </nav>
      <div class="clearfix"></div>
      
        <div class="social-icons">
  <div class="social-icons-right">
    
      <a class="fa fa-github" href="https://github.com/apereo"></a>
    
    
    
    
    <a class="fa fa-rss" href="/feed.xml"></a>
    
      <a class="fa fa-twitter" href="https://twitter.com/Apereo"></a>
    
    
    
    
    
      <a class="fa fa-envelope" href="mailto:info@apereo.org"></a>
    
    
    
    
    
    
  </div>
  <div class="right">
    
    
    
  </div>
</div>
<div class="clearfix"></div>

      
    </div>
  </div>
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<div class="post-header mb2">
  <h1>CAS Vulnerability Disclosure</h1>
  <span class="post-meta">Friday, Apr 8, 2016</span><br>
  
  <span class="post-meta small">
  
    10 minute read
  
  </span>
</div>

<article class="post-content">
  <h1 id="remember">Remember</h1>

<p>This post is <strong>NOT</strong> new. I am just collecting it here so it’s publicly available.
This was originally published as a secret gist on Github in April 2016.</p>

<h1 id="overview">Overview</h1>

<p>This is an Apereo CAS project vulnerability disclosure, describing an issue in CAS’s attempts to deserialize objects via the Apache Commons Collections library.</p>

<h1 id="affected-deployments">Affected Deployments</h1>

<p>The attack vector specifically applies to all deployments of CAS <code class="highlighter-rouge">v4.1.x</code> and <code class="highlighter-rouge">v4.2.x</code> deployments where the out-of-the-box default configuration of CAS is used for managing object serialization, encryption and signing of data.</p>

<p>You are <strong>NOT</strong> affected by this issue, if:</p>

<ul>
  <li>You have deployed a different CAS version, lower than <code class="highlighter-rouge">v4.1.0</code>.</li>
  <li>You have deployed CAS <code class="highlighter-rouge">v4.1.x</code> or <code class="highlighter-rouge">v4.2.x</code>, <strong>BUT</strong> you have removed the default CAS configuration for encryption/signing and have regenerated the appropriate settings for your own deployment.</li>
</ul>

<p>Exploiting the vulnerability hinges on getting the JVM to de-serialize Java objects from arbitrary serialized data. If the above conditions describe your deployment, we <strong>STRONGLY</strong> recommend that you take necessary action to patch your deployment based on the below instructions.</p>

<h1 id="severity">Severity</h1>

<p>This is a very serious issue where successfully exercising this vulnerability allows the adversary to inject arbitrary code. This disclosure is about a specific exploit path involving a bugged version of Apache Commons Collections. This exploit path is only an instance of a larger JVM Java object deserialization security concern.</p>

<h1 id="patching">Patching</h1>

<p>Patch releases are now available to address CAS <code class="highlighter-rouge">v4.1.x</code> and <code class="highlighter-rouge">v4.2.x</code> deployments. Upgrades to the next patch version for each release should be a drop-in replacement, with some effort to appropriately reconfigure CAS encryption/signing settings via the <code class="highlighter-rouge">cas.properties</code> file.</p>

<h2 id="cas-41x">CAS 4.1.x</h2>

<h3 id="overlay">Overlay</h3>
<p>Modify your CAS overlay to point to version <code class="highlighter-rouge">4.1.7</code>.</p>

<p>A snippet of a <code class="highlighter-rouge">pom.xml</code> for a CAS overlay follows:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...

<span class="nt">&lt;dependencies&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.jasig.cas<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>cas-server-webapp<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>${cas.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;type&gt;</span>war<span class="nt">&lt;/type&gt;</span>
        <span class="nt">&lt;scope&gt;</span>runtime<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>

<span class="nt">&lt;properties&gt;</span>
    <span class="nt">&lt;cas.version&gt;</span>4.1.7<span class="nt">&lt;/cas.version&gt;</span>
<span class="nt">&lt;/properties&gt;</span>
...
</code></pre></div></div>

<h3 id="tgc-settings">TGC Settings</h3>

<p>Locate your <code class="highlighter-rouge">cas.properties</code> file and find the <code class="highlighter-rouge">tgc.*</code> settings.</p>

<ul>
  <li>
    <p>If your CAS deployment is <strong>NOT</strong> using the default encryption/signing keys provided by CAS and you have regenerated new keys and have replaced the default, you can safely ignore this step and leave your key configuration of signing/encryption in place without any further changes.</p>
  </li>
  <li>
    <p>If your CAS deployment <strong>IS</strong> using the default encryption/signing keys provided by CAS and you have <strong>NOT</strong> regenerated new keys to replace the default, you <strong>MUST</strong> take action to regenerate the keys.</p>
  </li>
</ul>

<p>You can choose one of the two approaches described below to handle key regeneration.</p>

<h4 id="1-let-cas-generate-keys">1) Let CAS Generate Keys</h4>

<p>Blank/comment out the following <code class="highlighter-rouge">tgc</code> settings:</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># tgc.encryption.key=
# tgc.signing.key=
</span></code></pre></div></div>

<p>Build and deploy your CAS deployment once. Upon startup, CAS will notice that no keys are defined, and it will appropriately generate keys for you automatically. Your CAS logs will then show the following snippet:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>WARN <span class="o">[</span>org.jasig.cas.util.BaseStringCipherExecutor] - &lt;Secret key <span class="k">for </span>encryption is not defined. CAS will attempt to auto-generate the encryption key&gt;
WARN <span class="o">[</span>org.jasig.cas.util.BaseStringCipherExecutor] - &lt;Generated encryption key ABC of size ... <span class="nb">.</span> The generated key MUST be added to CAS settings.&gt;
WARN <span class="o">[</span>org.jasig.cas.util.BaseStringCipherExecutor] - &lt;Secret key <span class="k">for </span>signing is not defined. CAS will attempt to auto-generate the signing key&gt;
WARN <span class="o">[</span>org.jasig.cas.util.BaseStringCipherExecutor] - &lt;Generated signing key XYZ of size ... <span class="nb">.</span> The generated key MUST be added to CAS settings.&gt;
</code></pre></div></div>

<p>You should then grab each generated key for encryption and signing, and put them inside your <code class="highlighter-rouge">cas.properties</code> file for each now-enabled setting:</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">tgc.encryption.key</span><span class="p">=</span><span class="s">ABC</span>
<span class="py">tgc.signing.key</span><span class="p">=</span><span class="s">XYZ</span>
</code></pre></div></div>

<h4 id="2-manually-generate-keys">2) Manually Generate Keys</h4>

<p>Using a <code class="highlighter-rouge">git</code> client, clone and build the following project:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/mitreid-connect/json-web-key-generator.git
<span class="nb">cd </span>json-web-key-generator
mvn clean package
<span class="nb">cd </span>target

<span class="c"># Encryption Key</span>
java <span class="nt">-jar</span> json-web-key-generator-0.3-SNAPSHOT-jar-with-dependencies.jar <span class="nt">-t</span> oct <span class="nt">-s</span> 256

<span class="c">#</span>
<span class="c"># Full key:</span>
<span class="c"># {</span>
<span class="c">#   "kty": "oct",</span>
<span class="c">#   "k": "ABC"</span>
<span class="c"># }</span>
<span class="c">#</span>

<span class="c"># Signing Key</span>
java <span class="nt">-jar</span> json-web-key-generator-0.3-SNAPSHOT-jar-with-dependencies.jar <span class="nt">-t</span> oct <span class="nt">-s</span> 512

<span class="c"># Full key:</span>
<span class="c"># {</span>
<span class="c">#   "kty": "oct",</span>
<span class="c">#   "k": "XYZ"</span>
<span class="c"># }</span>

</code></pre></div></div>
<p>You should then grab each generated key for encryption and signing, and put them inside your <code class="highlighter-rouge">cas.properties</code> file for each now-enabled setting:</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">tgc.encryption.key</span><span class="p">=</span><span class="s">ABC</span>
<span class="py">tgc.signing.key</span><span class="p">=</span><span class="s">XYZ</span>
</code></pre></div></div>

<h3 id="webflow-settings">Webflow Settings</h3>

<p>Locate your <code class="highlighter-rouge">cas.properties</code> file and find the <code class="highlighter-rouge">webflow.*</code> settings. If you do not see them in your configuration, go ahead and define them:</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># webflow.encryption.key=
# webflow.signing.key=
</span></code></pre></div></div>

<p>You can choose one of the two approaches described below to handle key regeneration.</p>

<h4 id="1-let-cas-generate-keys-1">1) Let CAS Generate Keys</h4>

<p>Blank/comment out the following <code class="highlighter-rouge">webflow</code> settings:</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># webflow.encryption.key=
# webflow.signing.key=
</span></code></pre></div></div>

<p>Build and deploy your CAS deployment once. Upon startup, CAS will notice that no keys are defined, and it will appropriately generate keys for you automatically. Your CAS logs will then show the following snippet:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>WARN <span class="o">[</span>org.jasig.cas.util.BinaryCipherExecutor] - &lt;Secret key <span class="k">for </span>encryption is not defined. CAS will attempt to auto-generate the encryption key&gt;
WARN <span class="o">[</span>org.jasig.cas.util.BinaryCipherExecutor] - &lt;Generated encryption key ABC of size ... <span class="nb">.</span> The generated key MUST be added to CAS settings.&gt;
WARN <span class="o">[</span>org.jasig.cas.util.BinaryCipherExecutor] - &lt;Secret key <span class="k">for </span>signing is not defined. CAS will attempt to auto-generate the signing key&gt;
WARN <span class="o">[</span>org.jasig.cas.util.BinaryCipherExecutor] - &lt;Generated signing key XYZ of size ... <span class="nb">.</span> The generated key MUST be added to CAS settings.&gt;
</code></pre></div></div>

<p>You should then grab each generated key for encryption and signing, and put them inside your <code class="highlighter-rouge">cas.properties</code> file for each now-enabled setting:</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">webflow.encryption.key</span><span class="p">=</span><span class="s">ABC</span>
<span class="py">webflow.signing.key</span><span class="p">=</span><span class="s">XYZ</span>
</code></pre></div></div>

<h4 id="2-manually-generate-keys-1">2) Manually Generate Keys</h4>

<p>Using a <code class="highlighter-rouge">git</code> client, clone and build the following project:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/mitreid-connect/json-web-key-generator.git
<span class="nb">cd </span>json-web-key-generator
mvn clean package
<span class="nb">cd </span>target

<span class="c"># Encryption Key</span>
java <span class="nt">-jar</span> json-web-key-generator-0.3-SNAPSHOT-jar-with-dependencies.jar <span class="nt">-t</span> oct <span class="nt">-s</span> 96

<span class="c">#</span>
<span class="c"># Full key:</span>
<span class="c"># {</span>
<span class="c">#   "kty": "oct",</span>
<span class="c">#   "k": "ABC"</span>
<span class="c"># }</span>
<span class="c">#</span>

<span class="c"># Signing Key</span>
java <span class="nt">-jar</span> json-web-key-generator-0.3-SNAPSHOT-jar-with-dependencies.jar <span class="nt">-t</span> oct <span class="nt">-s</span> 512

<span class="c"># Full key:</span>
<span class="c"># {</span>
<span class="c">#   "kty": "oct",</span>
<span class="c">#   "k": "XYZ"</span>
<span class="c"># }</span>

</code></pre></div></div>
<p>You should then grab each generated key for encryption and signing, and put them inside your <code class="highlighter-rouge">cas.properties</code> file for each now-enabled setting:</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">webflow.encryption.key</span><span class="p">=</span><span class="s">ABC</span>
<span class="py">webflow.signing.key</span><span class="p">=</span><span class="s">XYZ</span>
</code></pre></div></div>

<h3 id="xml-configuration">XML Configuration</h3>

<p>If you have manually overridden the <code class="highlighter-rouge">cas-servlet.xml</code> file, you will need to make sure the following blocks are present
in the configuration:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Note that the Person Directory project requires the following configuration in CAS overlays:

```xml

Note that the Person Directory project requires the following configuration in CAS overlays:

```xml
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"loginFlowStateTranscoder"</span> <span class="na">class=</span><span class="s">"org.jasig.spring.webflow.plugin.EncryptedTranscoder"</span>
        <span class="na">c:cipherBean-ref=</span><span class="s">"loginFlowCipherBean"</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"loginFlowCipherBean"</span> <span class="na">class=</span><span class="s">"org.jasig.cas.web.flow.CasWebflowCipherBean"</span>
    <span class="na">c:cipherExecutor-ref=</span><span class="s">"webflowCipherExecutor"</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"webflowCipherExecutor"</span> <span class="na">class=</span><span class="s">"org.jasig.cas.util.BinaryCipherExecutor"</span>
    <span class="na">c:encryptionSecretKey=</span><span class="s">"${webflow.encryption.key:}"</span>
    <span class="na">c:signingSecretKey=</span><span class="s">"${webflow.signing.key:}"</span><span class="nt">/&gt;</span>
</code></pre></div></div>

<p>Re-adjust the beans accordingly, and remove the built-in keystore.</p>

<h3 id="finally">Finally</h3>
<p>Rebuild and redeploy your CAS overlay.</p>

<h2 id="cas-42x">CAS 4.2.x</h2>

<p>Modify your CAS overlay to point to version <code class="highlighter-rouge">4.2.1</code>.</p>

<p>A snippet of a <code class="highlighter-rouge">pom.xml</code> for a CAS overlay follows:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...

<span class="nt">&lt;dependencies&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.jasig.cas<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>cas-server-webapp<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>${cas.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;type&gt;</span>war<span class="nt">&lt;/type&gt;</span>
        <span class="nt">&lt;scope&gt;</span>runtime<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>

<span class="nt">&lt;properties&gt;</span>
    <span class="nt">&lt;cas.version&gt;</span>4.2.1<span class="nt">&lt;/cas.version&gt;</span>
<span class="nt">&lt;/properties&gt;</span>
...
</code></pre></div></div>

<h3 id="tgc-settings-1">TGC Settings</h3>

<p>Locate your <code class="highlighter-rouge">cas.properties</code> file and find the <code class="highlighter-rouge">tgc.*</code> settings.</p>

<ul>
  <li>
    <p>If your CAS deployment is <strong>NOT</strong> using the default encryption/signing keys provided by CAS and you have regenerated new keys and have replaced the default, you can safely ignore this step and leave your key configuration of signing/encryption in place without any further changes.</p>
  </li>
  <li>
    <p>If your CAS deployment <strong>IS</strong> using the default encryption/signing keys provided by CAS and you have <strong>NOT</strong> regenerated new keys to replace the default, you <strong>MUST</strong> take action to regenerate the keys.</p>
  </li>
</ul>

<p>You can choose one of the two approaches described below to handle key regeneration.</p>

<h4 id="1-let-cas-generate-keys-2">1) Let CAS Generate Keys</h4>

<p>Blank/comment out the following <code class="highlighter-rouge">tgc</code> settings:</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># tgc.encryption.key=
# tgc.signing.key=
</span></code></pre></div></div>

<p>Build and deploy your CAS deployment. Upon startup, CAS will notice that no keys are defined, and it will appropriately generate keys for you automatically. Your CAS logs will then show the following snippet:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>WARN <span class="o">[</span>org.jasig.cas.util.BaseStringCipherExecutor] - &lt;Secret key <span class="k">for </span>encryption is not defined. CAS will attempt to auto-generate the encryption key&gt;
WARN <span class="o">[</span>org.jasig.cas.util.BaseStringCipherExecutor] - &lt;Generated encryption key ABC of size ... <span class="nb">.</span> The generated key MUST be added to CAS settings.&gt;
WARN <span class="o">[</span>org.jasig.cas.util.BaseStringCipherExecutor] - &lt;Secret key <span class="k">for </span>signing is not defined. CAS will attempt to auto-generate the signing key&gt;
WARN <span class="o">[</span>org.jasig.cas.util.BaseStringCipherExecutor] - &lt;Generated signing key XYZ of size ... <span class="nb">.</span> The generated key MUST be added to CAS settings.&gt;
</code></pre></div></div>

<p>You should then grab each generated key for encryption and signing, and put them inside your <code class="highlighter-rouge">cas.properties</code> file for each now-enabled setting:</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">tgc.encryption.key</span><span class="p">=</span><span class="s">ABC</span>
<span class="py">tgc.signing.key</span><span class="p">=</span><span class="s">XYZ</span>
</code></pre></div></div>
<p>Rebuild and redeploy your CAS overlay.</p>

<h4 id="2-manually-generate-keys-2">2) Manually Generate Keys</h4>

<p>Using a <code class="highlighter-rouge">git</code> client, clone and build the following project:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/mitreid-connect/json-web-key-generator.git
<span class="nb">cd </span>json-web-key-generator
mvn clean package
<span class="nb">cd </span>target

<span class="c"># Encryption Key</span>
java <span class="nt">-jar</span> json-web-key-generator-0.3-SNAPSHOT-jar-with-dependencies.jar <span class="nt">-t</span> oct <span class="nt">-s</span> 256

<span class="c">#</span>
<span class="c"># Full key:</span>
<span class="c"># {</span>
<span class="c">#   "kty": "oct",</span>
<span class="c">#   "k": "ABC"</span>
<span class="c"># }</span>
<span class="c">#</span>

<span class="c"># Signing Key</span>
java <span class="nt">-jar</span> json-web-key-generator-0.3-SNAPSHOT-jar-with-dependencies.jar <span class="nt">-t</span> oct <span class="nt">-s</span> 512

<span class="c"># Full key:</span>
<span class="c"># {</span>
<span class="c">#   "kty": "oct",</span>
<span class="c">#   "k": "XYZ"</span>
<span class="c"># }</span>

</code></pre></div></div>
<p>You should then grab each generated key for encryption and signing, and put them inside your <code class="highlighter-rouge">cas.properties</code> file for each now-enabled setting:</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">tgc.encryption.key</span><span class="p">=</span><span class="s">ABC</span>
<span class="py">tgc.signing.key</span><span class="p">=</span><span class="s">XYZ</span>
</code></pre></div></div>

<h3 id="webflow-settings-1">Webflow Settings</h3>

<p>Locate your <code class="highlighter-rouge">cas.properties</code> file and find the <code class="highlighter-rouge">webflow.*</code> settings. If you do not see them in your configuration, go ahead and define them:</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># webflow.encryption.key=
# webflow.signing.key=
</span></code></pre></div></div>

<p>You can choose one of the two approaches described below to handle key regeneration.</p>

<h4 id="1-let-cas-generate-keys-3">1) Let CAS Generate Keys</h4>

<p>Blank/comment out the following <code class="highlighter-rouge">webflow</code> settings:</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># webflow.encryption.key=
# webflow.signing.key=
</span></code></pre></div></div>

<p>Build and deploy your CAS deployment once. Upon startup, CAS will notice that no keys are defined, and it will appropriately generate keys for you automatically. Your CAS logs will then show the following snippet:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>WARN <span class="o">[</span>org.jasig.cas.util.BinaryCipherExecutor] - &lt;Secret key <span class="k">for </span>encryption is not defined. CAS will attempt to auto-generate the encryption key&gt;
WARN <span class="o">[</span>org.jasig.cas.util.BinaryCipherExecutor] - &lt;Generated encryption key ABC of size ... <span class="nb">.</span> The generated key MUST be added to CAS settings.&gt;
WARN <span class="o">[</span>org.jasig.cas.util.BinaryCipherExecutor] - &lt;Secret key <span class="k">for </span>signing is not defined. CAS will attempt to auto-generate the signing key&gt;
WARN <span class="o">[</span>org.jasig.cas.util.BinaryCipherExecutor] - &lt;Generated signing key XYZ of size ... <span class="nb">.</span> The generated key MUST be added to CAS settings.&gt;
</code></pre></div></div>

<p>You should then grab each generated key for encryption and signing, and put them inside your <code class="highlighter-rouge">cas.properties</code> file for each now-enabled setting:</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">webflow.encryption.key</span><span class="p">=</span><span class="s">ABC</span>
<span class="py">webflow.signing.key</span><span class="p">=</span><span class="s">XYZ</span>
</code></pre></div></div>

<h4 id="2-manually-generate-keys-3">2) Manually Generate Keys</h4>

<p>Using a <code class="highlighter-rouge">git</code> client, clone and build the following project:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/mitreid-connect/json-web-key-generator.git
<span class="nb">cd </span>json-web-key-generator
mvn clean package
<span class="nb">cd </span>target

<span class="c"># Encryption Key</span>
java <span class="nt">-jar</span> json-web-key-generator-0.3-SNAPSHOT-jar-with-dependencies.jar <span class="nt">-t</span> oct <span class="nt">-s</span> 96

<span class="c">#</span>
<span class="c"># Full key:</span>
<span class="c"># {</span>
<span class="c">#   "kty": "oct",</span>
<span class="c">#   "k": "ABC"</span>
<span class="c"># }</span>
<span class="c">#</span>

<span class="c"># Signing Key</span>
java <span class="nt">-jar</span> json-web-key-generator-0.3-SNAPSHOT-jar-with-dependencies.jar <span class="nt">-t</span> oct <span class="nt">-s</span> 512

<span class="c"># Full key:</span>
<span class="c"># {</span>
<span class="c">#   "kty": "oct",</span>
<span class="c">#   "k": "XYZ"</span>
<span class="c"># }</span>

</code></pre></div></div>
<p>You should then grab each generated key for encryption and signing, and put them inside your <code class="highlighter-rouge">cas.properties</code> file for each now-enabled setting:</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">webflow.encryption.key</span><span class="p">=</span><span class="s">ABC</span>
<span class="py">webflow.signing.key</span><span class="p">=</span><span class="s">XYZ</span>
</code></pre></div></div>

<h3 id="finally-1">Finally</h3>
<p>Rebuild and redeploy your CAS overlay.</p>

<h1 id="clustered-cas-deployments">Clustered CAS Deployments</h1>

<p>If you are running a cluster of CAS nodes, please be advised that the newly generated keys for all settings (regardless of the method of generation, whether CAS or you) <strong>MUST</strong> be shared with all CAS nodes in form of either a centralized or replicated/shared <code class="highlighter-rouge">cas.properties</code> file.</p>

<p>Failure to do so will completely break CAS functionality.</p>

<p>If you only have a single-node CAS deployment, there is nothing further for you to do.</p>

<h1 id="support">Support</h1>
<p>If you have questions on the details this vulnerability and how it might be reproduced, please contact <code class="highlighter-rouge">security@apereo.org</code> or <code class="highlighter-rouge">cas-appsec-public@apereo.org</code>.</p>

<h1 id="resources">Resources</h1>

<ul>
  <li><a href="https://blogs.apache.org/foundation/entry/apache_commons_statement_to_widespread">Apache Commons statement to widespread Java object de-serialisation vulnerability</a></li>
  <li><a href="https://commons.apache.org/proper/commons-collections/security-reports.html">Apache Commons Collections security reports</a></li>
</ul>

<p><a href="https://twitter.com/misagh84">Misagh Moayyed</a></p>

</article>


  <div class="share-page">
  Share this post!

  <div class="share-links">
    
      <a class="fa fa-facebook" href="https://facebook.com/sharer.php?u=https%3A%2F%2Fapereo.github.io%2F2016%2F04%2F08%2Fcommonsvulndisc%2F" rel="nofollow" target="_blank" title="Share on Facebook"></a>
    

    
      <a class="fa fa-twitter" href="https://twitter.com/intent/tweet?text=CAS+Vulnerability+Disclosure&amp;url=https%3A%2F%2Fapereo.github.io%2F2016%2F04%2F08%2Fcommonsvulndisc%2F" rel="nofollow" target="_blank" title="Share on Twitter"></a>
    

    
      <a class="fa fa-google-plus" href="https://plus.google.com/share?url=https%3A%2F%2Fapereo.github.io%2F2016%2F04%2F08%2Fcommonsvulndisc%2F" rel="nofollow" target="_blank" title="Share on Google+"></a>
    

    
      <a class="fa fa-linkedin" href="http://www.linkedin.com/shareArticle?url=https%3A%2F%2Fapereo.github.io%2F2016%2F04%2F08%2Fcommonsvulndisc%2F&amp;title=CAS+Vulnerability+Disclosure" rel="nofollow" target="_blank" title="Share on LinkedIn"></a>
    

    
      <a class="fa fa-digg" href="http://digg.com/submit?url=https%3A%2F%2Fapereo.github.io%2F2016%2F04%2F08%2Fcommonsvulndisc%2F&amp;title=CAS+Vulnerability+Disclosure" rel="nofollow" target="_blank" title="Share on Digg"></a>
    

    
      <a class="fa fa-tumblr" href="http://www.tumblr.com/share/link?url=https%3A%2F%2Fapereo.github.io%2F2016%2F04%2F08%2Fcommonsvulndisc%2F&amp;name=CAS+Vulnerability+Disclosure" rel="nofollow" target="_blank" title="Share on Tumblr"></a>
    

    
      <a class="fa fa-reddit" href="http://reddit.com/submit?url=https%3A%2F%2Fapereo.github.io%2F2016%2F04%2F08%2Fcommonsvulndisc%2F&amp;title=CAS+Vulnerability+Disclosure" rel="nofollow" target="_blank" title="Share on Reddit"></a>
    

    
      <a class="fa fa-stumbleupon" href="http://www.stumbleupon.com/submit?url=https%3A%2F%2Fapereo.github.io%2F2016%2F04%2F08%2Fcommonsvulndisc%2F&amp;title=CAS+Vulnerability+Disclosure" rel="nofollow" target="_blank" title="Share on StumbleUpon"></a>
    

    
      <a class="fa fa-hacker-news" onclick="parent.postMessage('submit','*')" href="https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fapereo.github.io%2F2016%2F04%2F08%2Fcommonsvulndisc%2F&amp;t=CAS+Vulnerability+Disclosure" rel="nofollow" target="_blank" title="Share on Hacker News"></a>
    
  </div>
</div>




  <div class="py2 post-footer">
  <!-- <img src="/images/me.jpeg" alt="John Otander" class="avatar" /> -->

  <p>
    Follow Apereo on <a href="https://twitter.com/Apereo">Twitter</a>.
  </p>
</div>










  <h3 class="related-post-title">Related Posts</h3>
  
    <div class="post ml2">
      <a href="/2019/02/01/610rc1-release/" class="post-link">
        <h4 class="post-title">CAS 6.1.0 RC1 Feature Release</h4>
        <p class="post-summary">...in which I present an overview of CAS 6.1.0 RC1 release.</p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2018/12/24/cas53-oohlalamobile-saml2-integration/" class="post-link">
        <h4 class="post-title">Apereo CAS - OohLala Mobile SAML2 Integration</h4>
        <p class="post-summary">Learn how to integrate OohLala Mobile with Apereo CAS running as a SAML2 identity provider.</p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2018/12/24/cas53-oclc-saml2-integration/" class="post-link">
        <h4 class="post-title">Apereo CAS - Cranium Cafe SAML2 Integration</h4>
        <p class="post-summary">Learn how to integrate Cranium Cafe with Apereo CAS running as a SAML2 identity provider.</p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2018/12/24/cas53-elumen-saml2-integration/" class="post-link">
        <h4 class="post-title">Apereo CAS - eLumen SAML2 Integration</h4>
        <p class="post-summary">Learn how to integrate eLumen with Apereo CAS running as a SAML2 identity provider.</p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2018/12/23/cas53-getrave-saml2-integration/" class="post-link">
        <h4 class="post-title">Apereo CAS - Rave SAML2 Integration</h4>
        <p class="post-summary">Learn how to integrate Rave with Apereo CAS running as a SAML2 identity provider.</p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2018/12/22/cas53-hiretouch-saml2-integration/" class="post-link">
        <h4 class="post-title">Apereo CAS - HireTouch SAML2 Integration</h4>
        <p class="post-summary">Learn how to integrate HireTouch with Apereo CAS running as a SAML2 identity provider.</p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2018/12/06/cas53-office365-saml2-integration/" class="post-link">
        <h4 class="post-title">Apereo CAS - Microsoft Office 365 SAML2 Integration</h4>
        <p class="post-summary">Learn how to integrate Microsoft Office 365 with Apereo CAS running as a SAML2 identity provider.</p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2018/12/04/cas53-happyfox-saml2-integration/" class="post-link">
        <h4 class="post-title">Apereo CAS - HappyFox SAML2 Integration</h4>
        <p class="post-summary">Learn how to integrate HappyFox with Apereo CAS running as a SAML2 identity provider.</p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2018/12/04/cas53-cisco-webex-saml2-integration/" class="post-link">
        <h4 class="post-title">Apereo CAS - Cisco Webex SAML2 Integration</h4>
        <p class="post-summary">Learn how to integrate Cisco Webex with Apereo CAS running as a SAML2 identity provider.</p>
      </a>
    </div>
  
    <div class="post ml2">
      <a href="/2018/12/03/cas53-vmwareidentitymgr-saml2-integration/" class="post-link">
        <h4 class="post-title">Apereo CAS - VMware Identity Manager SAML2 Integration</h4>
        <p class="post-summary">Learn how to integrate VMware Identity Manager with Apereo CAS running as a SAML2 identity provider.</p>
      </a>
    </div>
  


      </div>
    </div>
  </div>

  <footer class="center">
  <div class="measure">
    <small>
      Theme crafted with &lt;3 by <a href="http://johnotander.com">John Otander</a> (<a href="https://twitter.com/4lpine">@4lpine</a>).<br>
      &lt;/&gt; available on <a href="https://github.com/johnotander/pixyll">Github</a>.
    </small>
  </div>

          
</footer>
<!-- AnchorJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.0.0/anchor.min.js"></script>
<script>
    anchors.options.visible = 'always';
    anchors.add('article h1, article h2, article h3, article h4, article h5, article h6');
</script>

	
</body>
</html>
